---
name: Task - Build Rust

on:
  workflow_dispatch:
  workflow_call:

jobs:
  rust_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # selecting a toolchain either by action or manual `rustup` calls should happen
      # before the plugin, as the cache uses the current rustc version as its cache key
      - run: rustup show

      - uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Ganache
        run: |
          npm install -g ganache@7.9.0
          ganache --version

      - name: Install Solc
        run: |
          pip install solc-select
          solc-select install 0.8.19
          solc-select use 0.8.19
          solc --version

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      # Install and setup ASDF
      - name: Install ASDF and Scarb
        run: |
          git clone https://github.com/asdf-vm/asdf.git $HOME/.asdf --branch v0.14.1
          echo '. "$HOME/.asdf/asdf.sh"' >> $HOME/.bashrc
          echo '. "$HOME/.asdf/completions/asdf.bash"' >> $HOME/.bashrc
          . $HOME/.asdf/asdf.sh
          asdf plugin add scarb https://github.com/software-mansion/asdf-scarb.git
          asdf install scarb 2.8.4
          asdf install scarb 2.6.3
          asdf global scarb 2.8.4

      # Update HOME_DIR in Makefile
      - name: Update Makefile HOME_DIR
        run: |
          sed -i "s|HOME_DIR := /home/ubuntu|HOME_DIR := $HOME|" Makefile

      - name: Build the project
        run: |
          git submodule update --init --recursive
          make artifacts-linux
          cargo build --release --workspace

      # Add artifact upload step
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            target/release/karnot-bridge-deploy
            artifacts/
